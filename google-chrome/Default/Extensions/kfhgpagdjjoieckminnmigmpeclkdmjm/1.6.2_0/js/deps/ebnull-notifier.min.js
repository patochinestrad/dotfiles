/*!
 * EbnullNotifier
 * @author Gerrproger
 * @version  v1.3.2
 */
!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t,document):"function"==typeof define&&define.amd?define(null,function(){e(t,document)}):t.EbnullNotifier=e(t,document)}("undefined"!=typeof window?window:this,function(t,e){"use strict";class r{constructor(e,r=null,i={}){this.rawNotifs=[],this.fetchedTime=0,this.browser="browser"in t?browser:"chrome"in t?chrome:null,this.cacheStorage=t.localStorage,this.url=e,this.storage=r,this.opts={locale:i.locale||this._getLocale(),memCacheTime:i.memCacheTime||5e4,storCacheTime:i.storCacheTime||29e4}}async getNotifications(t=-1){const e=()=>{const e=this._filterNotifications(t);return e.counts=this._countMessages(),e};return await new Promise((t,r)=>{this._loadNotifications().then(()=>{t(e())}).catch(t=>{const i=e();i.error=t,r(i)})})}async getCounts(){return await new Promise((t,e)=>{this._loadNotifications().then(()=>{t(this._countMessages())}).catch(t=>{const r=this._countMessages();r.error=t,e(r)})})}markRead(t){if(!this.storage)throw new Error("No storage plugin is provided!");Array.isArray(t)||(t=[t]);if(!t.every(t=>this.rawNotifs.some(e=>e.id===t)))throw new Error("Some of the provided ids are wrong!");let e=this.storage.get("ebnullNotifier")||[];Array.isArray(e)||(e=[]),t.forEach(t=>{e.includes(t)||e.push(t)}),this.storage.set("ebnullNotifier",e)}invalidateCache(){this.rawNotifs=[],this.fetchedTime=0,this._removeCache()}_filterNotifications(t){if(!this.rawNotifs.length)return{important:[],normal:[]};const e=[],r=[],i=this._getRead();return this.rawNotifs.forEach(s=>{const n=!!s.important;if(!n&&t>-1&&e.length>=t)return;const o={important:n,title:this._getTxt(s.title),message:this._getTxt(s.message,!0),date:new Date(s.createdAt).toLocaleDateString(),read:i.includes(s.id),id:s.id};n?r.push(o):e.push(o)}),{important:r,normal:e}}_countMessages(){if(!this.rawNotifs.length)return{important:0,normal:0,notRead:0,notReadImportant:0,all:0};const t=this._getRead(),e=this.rawNotifs.filter(e=>!t.includes(e.id)),r=this.rawNotifs.filter(t=>!!t.important).length;return{important:r,normal:this.rawNotifs.length-r,notRead:e.length,notReadImportant:e.filter(t=>!!t.important).length,all:this.rawNotifs.length}}_getRead(){const t=this.storage&&this.storage.get("ebnullNotifier");return Array.isArray(t)?t:[]}_getTxt(t,e){const r=t[this.opts.locale]||t.en||"{no_text}";return(e?this._prettifyDom(this._getDom(this._replaceMarkdown(r))).body.innerHTML:this._getDom(r).body.innerText)||""}_getDom(t){return(new DOMParser).parseFromString(t,"text/html")}_prettifyDom(t){const e=["IMG","BR","HR"];return Array.prototype.slice.call(t.body.querySelectorAll("*")).reverse().forEach(r=>{const i=((r,i)=>{if(!r.tagName)return!1;let s=!1;return i.some(i=>{if(i.includes(r.tagName.toLowerCase())){if(!r.innerText&&!e.includes(r.tagName)&&r.firstChild&&!e.includes(r.firstChild.tagName))return;return s=t.createElement(i[0]),s.innerHTML=r.innerHTML,!0}}),s})(r,[["h4","h1"],["h5","h2"],["h6","h3"],["i","em"],["b","strong"],["s","del"],["u"],["ul"],["ol"],["li"],["a"],["img"],["blockquote"],["code"],["br"],["hr"],["p"]]);i&&"A"===i.tagName?(i.href=r.href,i.target="_blank"):i&&"IMG"===i.tagName&&(i.src=r.src,i.alt=r.alt),r.parentElement.replaceChild(i||t.createTextNode(r.innerText+" "),r)}),t}_replaceMarkdown(t){const e=(t,e)=>r=>r.replace(t,e),r=e(/((\n\t)(.*))+/g,t=>"\n<pre>"+t+"</pre>"),i=e(/(`)(.*?)\1/g,(t,e,r)=>"<code>"+r+"</code>"),s=e(/!\[([^\[]+)\]\(([^\)]+)\)/g,(t,e,r)=>'<img src="'+r+'" alt="'+e+'" />'),n=e(/\[([^\[]+)\]\(([^\)]+)\)/g,(t,e,r)=>'<a href="'+r+'">'+e+"</a>"),o=e(/\n(#+\s*)(.*)/g,(t,e,r)=>"\n<h"+e.trim().length+">"+r+"</h"+e.trim().length+">"),a=e(/(\*{1,2})(.*?)\1/g,(t,e,r)=>"<"+(1==e.trim().length?"em":"strong")+">"+r+"</"+(1==e.trim().length?"em":"strong")+">"),h=e(/(\~\~)(.*?)\1/g,(t,e,r)=>"<del>"+r+"</del>"),l=e(/\n(&gt;|\>)(.*)/g,(t,e,r)=>"\n<blockquote>"+r+"</blockquote>"),c=e(/\n((\-{3,})|(={3,}))/g,t=>"\n<hr />"),u=e(/(\n\s*(\-|\+)\s.*)+/g,t=>{let e="";return t.trim().split("\n").forEach(t=>{e+="<li>"+t.substring(2)+"</li>"}),"\n<ul>"+e+"</ul>"}),m=e(/(\n\s*([0-9]+\.)\s.*)+/g,t=>{let e="";return t.trim().split("\n").forEach(t=>{e+="<li>"+t.substring(t.indexOf(".")+2)+"</li>"}),"\n<ol>"+e+"</ol>"}),g=e(/\n+(?!<pre>)(?!<h)(?!<ul>)(?!<blockquote)(?!<hr)(?!\t)([^\n]+)\n/g,(t,e)=>"<p>"+e+"</p>");return e(/\n(<pre>)((\n|.)*)(<\/pre>)/g,(t,e,r,i,s)=>{let n="";return r.split("\n").forEach(t=>{n+=t.substring(1)+"\n"}),e+n+s})((t=>g(m(u(c(l(h(a(o(n(s(i(r(t)))))))))))))("\n"+t+"\n")).trim()}async _loadNotifications(){if(this.fetchedTime+this.opts.memCacheTime>new Date)return new Promise(t=>t());const t=this._readCache(this.opts.storCacheTime);return t?(this.fetchedTime=t.fetchedTime,this.rawNotifs=t.rawNotifs,new Promise(t=>t())):await fetch(this.url).then(t=>{if(!t.ok)throw new Error(t.statusText||t.status);return t.json()}).then(t=>{this.rawNotifs=t.sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)),this.fetchedTime=this._setCache(this.rawNotifs)})}_setCache(t){const e=(new Date).getTime();return this.cacheStorage.setItem(`ebnullNotifier|${this.url}`,JSON.stringify({rawNotifs:t,fetchedTime:e})),e}_readCache(t){const e=this.cacheStorage.getItem(`ebnullNotifier|${this.url}`);if(!e)return!1;const r=JSON.parse(e);return r.fetchedTime+t>new Date?r:(this._removeCache(),!1)}_removeCache(){this.cacheStorage.removeItem(`ebnullNotifier|${this.url}`)}_getLocale(){return(this.browser&&this.browser.i18n?this.browser.i18n.getMessage("@@ui_locale"):"navigator"in t?navigator.language:"en").replace(/(_|-).*$/,"")}}return r});