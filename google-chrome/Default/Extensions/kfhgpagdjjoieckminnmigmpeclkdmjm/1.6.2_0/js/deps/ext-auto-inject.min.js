/*!
 * ExtAutoInject
 * Part of the ExtHelpers project
 * @version  v1.7.0
 * @author   Gerrproger
 * @license  MIT License
 * Repo:     http://github.com/gerrproger/ext-helpers
 * Issues:   http://github.com/gerrproger/ext-helpers/issues
 */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=t(e,document):"function"==typeof define&&define.amd?define(null,(function(){t(e,document)})):e.ExtAutoInject=t(e,document)}("undefined"!=typeof window?window:this,(function(e,t){"use strict";return class{constructor(t,s){if(this.isBackgroundScript=!(!chrome.extension.getBackgroundPage||chrome.extension.getBackgroundPage()!==e),this.manifest=chrome.runtime.getManifest(),!this.isBackgroundScript&&(s=t),s&&"function"!=typeof s)throw new Error("Callback should be a function!");if(this.isBackgroundScript&&t&&"string"!=typeof t&&"object"!=typeof t)throw new Error("Ignore parameter should be a sting (match pattern) or a regular expression or an array of strings/expressions!");return new Promise((r=>{const o=t=>{s&&s.call(e,t),r(t)};this.isBackgroundScript?this._background(t,o):this._content(o)}))}_background(t,s){const r=(e,t)=>{const s=s=>{t.files[s]&&t.files[s].forEach((r=>{chrome.tabs["js"===s?"executeScript":"insertCSS"](e,{file:r,allFrames:t.allFrames,matchAboutBlank:t.matchAboutBlank})}))};chrome.tabs.executeScript(e,{code:`window.extAutoInjectInfo=${JSON.stringify(this.constructor.info)};window.extAutoInjectMatches=${JSON.stringify(t.matches)};`,allFrames:t.allFrames,matchAboutBlank:t.matchAboutBlank},(()=>{if(chrome.runtime.lastError)switch(chrome.runtime.lastError.message){case"Cannot access contents of the page. Extension manifest must request permission to access the respective host.":case"The extensions gallery cannot be scripted.":case"The frame was removed.":case"The tab was closed.":return;default:throw new Error(chrome.runtime.lastError.message)}s("js"),s("css")}))},o=()=>{this.manifest.content_scripts.forEach((e=>{const t=(e=>{const t={allFrames:e.all_frames,matchAboutBlank:e.match_about_blank,matches:e.matches,files:{}},s=s=>{Array.isArray(e[s])&&(t.files[s]=e[s].filter((e=>{const t=c.some((t=>{if(e.match(t))return!0}));return!t})))};return s("js"),s("css"),t})(e);chrome.tabs.query({url:e.matches},(s=>{s&&s.forEach((s=>{let o=[];e.exclude_matches&&(o=o.concat(e.exclude_matches)),e.exclude_globs&&(o=o.concat(e.exclude_globs));const n=o.some((e=>{if(e=this.constructRegExp(e),s.url.match(e))return!0}));if(!n){if(e.include_globs){if(!e.include_globs.some((e=>{if(e=this.constructRegExp(e),s.url.match(e))return!0})))return}r(s.id,t)}}))}))}))},n=(r,n)=>{e.extAutoInjectInfo={date:new Date,version:this.manifest.version,previousVersion:n,reason:r},n&&s(this.constructor.info),!1!==t&&o()};let c="object"==typeof t||"string"==typeof t?Array.isArray(t)?t:[t]:[];c=c.map((e=>"string"==typeof e?this.constructRegExp(e):e)),chrome.runtime.onInstalled.addListener((e=>{n(e.reason,e.previousVersion)})),setTimeout((()=>{!this.constructor.info&&n("enabled")}),1e3)}_content(t){const s=r=>{r.source===e&&r.data.extAutoInjected&&(e.removeEventListener("message",s),e.extAutoInjectInfo=r.data.extAutoInjected,t(this.constructor.info))};e.postMessage({extAutoInjected:this.constructor.info},"*"),setTimeout((()=>{e.addEventListener("message",s)}),0)}static get pageMathes(){const t=e.location.href,s=e.extAutoInjectMatches;return!s||s.some((e=>{if("<all_urls>"===e)return!0;const s=this.constructRegExp(e);return!!t.match(s)}))}static get info(){return e.extAutoInjectInfo}static constructRegExp(e){return new RegExp(`^${e.replace(/\?/g,".").replace(/\*\.?/g,".*").replace(/\//g,"/").replace(/\./g,".")}$`)}}}));
