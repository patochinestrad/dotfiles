/*!
 * ExtStorageManager
 * Part of the ExtHelpers project
 * @version  v1.7.0
 * @author   Gerrproger
 * @license  MIT License
 * Repo:     http://github.com/gerrproger/ext-helpers
 * Issues:   http://github.com/gerrproger/ext-helpers/issues
 */
!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t,document):"function"==typeof define&&define.amd?define(null,(function(){e(t,document)})):t.ExtStorageManager=e(t,document)}("undefined"!=typeof window?window:this,(function(t,e){"use strict";return function(e,i,s){class a extends Error{constructor(t){super(t),this.name="ExtStorageManagerError",this.stack=this.stack.replace(/\s\s\s\sat Storage.+(\n|$)/g,"")}}return new class{constructor(t="sync",e={},i=(()=>{})){const s=function(){if(!this.initialized)throw new a("Storage is not initialized yet!");return arguments[0].apply(this,Array.prototype.slice.call(arguments,1))};this.name=t,this.callback=i,this.onUpdateCalls=[],this.data={},this.defData=e||{},this.skip=!1,this.initialized=!1,this.nativeStorage=chrome.storage[t],this.api={get:s.bind(this,this.get),set:s.bind(this,this.set),remove:s.bind(this,this.remove),reset:s.bind(this,this.reset),clear:s.bind(this,this.clear),onUpdate:this.onUpdate.bind(this),offUpdate:this.offUpdate.bind(this),getBytesInUse:this.getBytesInUse.bind(this),limits:this.limits},this.nativeStorage.get(this._checkStorage.bind(this)),this.nativeStorage.onChanged.addListener(this._updateStorage.bind(this))}_checkStorage(e){const i=this._extend(e,this.defData),s=chrome.runtime.lastError&&chrome.runtime.lastError.message;if(this.data=i.object,i.changed.length){const t={};i.changed.forEach((e=>{t[e]=this.data[e]})),this.nativeStorage.set(t)}if(this.initialized=!0,this.callback.call(t,this.get(),s),s)throw new a(s)}_isObject(t){return null!==t&&"object"===typeof t&&!Array.isArray(t)}_copyObject(t){return JSON.parse(JSON.stringify(t))}_extend(t,e){const i=[],s=(t,e,a)=>{Object.keys(e).forEach((n=>{var o;void 0===t[n]?(t[n]=e[n],o=a||n,!i.includes(o)&&i.push(o)):this._isObject(e[n])&&s(t[n],e[n],a||n)}))};return t=this._copyObject(t||{}),e=this._copyObject(e||{}),s(t,e),{object:t,changed:i}}_updateStorage(e){if(this.skip)return;const i=[],s=(t,e,a)=>{const n=Object.keys(t);n.length?n.forEach((n=>{this._isObject(t[n])&&this._isObject(e[n])?s(t[n],e[n],`${a}.${n}`):t[n]!==e[n]&&i.push(`${a}.${n}`)})):i.push(a)};Object.keys(e).forEach((t=>{if(!e[t].hasOwnProperty("newValue"))return delete this.data[t],void i.push(t);this._isObject(e[t].newValue)&&this._isObject(this.data[t])?s(e[t].newValue,this.data[t],t):e[t].newValue!==this.data[t]&&i.push(t),this.data[t]=e[t].newValue})),i.forEach((e=>{this.onUpdateCalls.forEach((i=>{(new RegExp(`^${i[0].replace(/\./g,"\\.")}`).test(e)||new RegExp(`^${e.replace(/\./g,"\\.")}`).test(i[0]))&&i[1].call(t,this.get(i[0]))}))}))}_replaceStorage(t,e){t=this._copyObject(t);const i=Object.keys(this.data).filter((e=>!t.hasOwnProperty(e)));this.data=t,this.skip=!0,i.length&&this.nativeStorage.remove(i,this._callback.bind(this,e)),this.nativeStorage.set(this.data,(()=>{this.skip=!1,this._callback(e,chrome.runtime.lastError)}))}_callback(e,i){const s=(i=i||chrome.runtime.lastError)&&i.message;if("function"==typeof e&&e.call(t,s),s)throw new a(s)}get(t){if(!t)return this._copyObject(this.data);let e=this.data;return t.split(/\./g).some((t=>{if(!e||void 0===e[t])return!0;e=e[t]}))?void 0:this._isObject(e)?this._copyObject(e):e}set(t,e,i){if(t&&"string"!=typeof t)throw new a("Path should be a string!");if(i&&"function"!=typeof i)throw new a("Callback should be a function!");if(this._isObject(e)&&(e=this._copyObject(e)),!t){if(!this._isObject(e))throw new a("Could not store a non-object in the storage root!");return this._replaceStorage(e,i),this.api}let s=this.data;const n=t.split(/\./g),o=n.length-1;if(n.some(((t,i)=>{if(i===o)s[t]=e;else if(void 0===s[t])s=s[t]={};else{if(!this._isObject(s[t]))return!0;s=s[t]}})))throw new a("One of the path nestings is not an object!");return this.nativeStorage.set({[n[0]]:this.data[n[0]]},this._callback.bind(this,i)),this.api}remove(t,e,i){if("function"==typeof e&&void 0===i&&(i=e,e=!1),!t)throw new a("Path is not passed!");if(void 0!==e&&"boolean"!=typeof e)throw new a("SkipNonexistent should be a boolean!");if(void 0!==i&&"function"!=typeof i)throw new a("Callback should be a function!");const s=t.split(/\./g),n=s.length-1;if(!n){if(!this.data.hasOwnProperty(s[0])){if(e)return this._callback(i),this.api;throw new a("Passed path does not exists!")}return delete this.data[s[0]],this.nativeStorage.remove(s[0],this._callback.bind(this,i)),this.api}let o=this.data;if(s.some(((t,e)=>{if(e===n){if(void 0===o[t])return!0;delete o[t],this.nativeStorage.set({[s[0]]:this.data[s[0]]},this._callback.bind(this,i))}else{if(!this._isObject(o[t]))throw new a("One of the path nestings is not an object!");o=o[t]}}))){if(!e)throw new a("Passed path does not exists!");this._callback(i)}return this.api}onUpdate(t,e,i){if("function"==typeof t&&(i=e=t,t=null),"function"!=typeof e)throw new a("Callback function is not passed!");if(i&&"string"!=typeof i)throw new a("Namespace should be a string or undefined!");return this.onUpdateCalls.push([t||"",e,i||""]),this.api}offUpdate(t){if(t&&"string"!=typeof t)throw new a("Namespace should be a string or undefined!");return this.onUpdateCalls=t?this.onUpdateCalls.filter((e=>e[2]!==t)):[],this.api}reset(t){if(t&&"function"!=typeof t)throw new a("Callback should be a function!");return this._replaceStorage(this.defData,t),this.api}clear(t){if(t&&"function"!=typeof t)throw new a("Callback should be a function!");return this._replaceStorage({},t),this.api}getBytesInUse(e,i){if("function"==typeof e)i=e,e=null;else if("function"!=typeof i)throw new a("Callback function is not passed!");return this.nativeStorage.getBytesInUse(e||null,(s=>{const a=this.nativeStorage["QUOTA_BYTES"+(e?"_PER_ITEM":"")];i.call(t,s,a)})),this.api}get limits(){return{maxItems:this.nativeStorage.MAX_ITEMS,maxSustainedWriteOperationsPerMinute:this.nativeStorage.MAX_SUSTAINED_WRITE_OPERATIONS_PER_MINUTE,maxWriteOperationsPerHour:this.nativeStorage.MAX_WRITE_OPERATIONS_PER_HOUR,maxWriteOperationsPerMinute:this.nativeStorage.MAX_WRITE_OPERATIONS_PER_MINUTE,quotaBytes:this.nativeStorage.QUOTA_BYTES,quotaBytesPerItem:this.nativeStorage.QUOTA_BYTES_PER_ITEM}}}(s,e,i).api}}));
