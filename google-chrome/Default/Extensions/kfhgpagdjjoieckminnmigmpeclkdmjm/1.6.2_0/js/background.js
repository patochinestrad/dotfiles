(function(){"use strict";const O=chrome.runtime.getManifest().version,i={settings:{enabled:!0,claimsHistoryFilter:"all",eventsHistoryFilter:"all",preventPause:!0,autoReload:!0,integrityReload:!0,autoStart:!0,preventDiscard:!0,clickPause:!0,changeIcon:!1,cancelRaid:!1,hideExtensions:!1,showPreviews:!1,notificationAlert:!0,claimPoints:!0,claimDrops:!0,claimMoments:!0,alerts:{points:{visual:!0,sound:!1,native:!1,volume:30,duration:30},drops:{visual:!0,sound:!1,native:!1,volume:30,duration:60},moments:{visual:!0,sound:!1,native:!1,volume:30,duration:60},raids:{visual:!0,sound:!1,native:!1,volume:30,duration:120},predictionsStart:{visual:!0,sound:!1,native:!1,volume:30,duration:300},predictionsResult:{visual:!0,sound:!1,native:!1,volume:30,duration:120},reloads:{visual:!0,sound:!1,native:!1,volume:30,duration:180}}},statistics:{totalPoints:0,totalDrops:0,totalMoments:0},lastPoints:[],lastDrops:[],lastMoments:[],lastRaids:[],lastPredictions:[],lastReloads:[],config:{lastPointsMaxlength:20,lastDropsMaxlength:10,lastMomentsMaxlength:10,lastRaidsMaxlength:20,lastPredictionsMaxlength:15,lastReloadsMaxlength:20,waitPlayerError:4*1e3,playbackFailedMax:6,fetchFailedMax:8,playerHealthDelay:10*1e3,playerHealthDelayMax:2*60*1e3,resetFetchFailedDelay:2*60*1e3,integrityFailedMax:3,resetIntegrityFailedDelay:30*60*1e3,luckyFactorPredict:4,unmuteRetries:2,unmutePlayerDelay:1.3*1e3,activateWindowDelay:.5*1e3,alertShowDelay:5*60*1e3,defaultDelay:2*1e3,alertDelay:2*1e3,waitRenderDelay:.2*1e3,shortDelay:.1*1e3,reloadDelay:3*1e3,transitionDelay:.6*1e3,reloadErrorDelay:5*60*1e3,reloadAutoDelay:10*60*1e3,checkLiveDelay:60*1e3,checkPointsDelay:10*60*1e3,checkDropsDelay:15*60*1e3,nextPromoDelay:1800,hashPointsFs:"#ate_points_fullscreen",hashPointsFsP:"#ate_points_fullscreen_prediction",hashDrop:"#ate_drop_",dropsTag:"tl=DropsEnabled",queryReload:"atbe_reload",queryRaid:"referrer",querySelectors:{playerContainer:'.persistent-player:not(.persistent-player__border--mini) .video-player__container, div[data-a-target="embed-video-container"] .video-player__container',playerElement:'.persistent-player:not(.persistent-player__border--mini) .video-player__container video, div[data-a-target="embed-video-container"] .video-player__container video',playerOverlay:'.persistent-player:not(.persistent-player__border--mini) .video-player__overlay, div[data-a-target="embed-video-container"] .video-player__overlay',playerErrorButton:'.persistent-player:not(.persistent-player__border--mini) .content-overlay-gate__content button, div[data-a-target="embed-video-container"] .content-overlay-gate__content button',playerEvents:".persistent-player:not(.persistent-player__border--mini) .video-player__container div[id][aria-label]",playerClicker:'.persistent-player:not(.persistent-player__border--mini) .video-player__container .click-handler, div[data-a-target="embed-video-container"] .video-player__container .click-handler',mainContainer:"main.twilight-main",favicon16:'link[rel="icon"][sizes="16x16"]',favicon32:'link[rel="icon"][sizes="32x32"]',pointsSummary:".community-points-summary",pointsButton:".community-points-summary button",predictionsButton:".predictions-list-item__body",dropsName:".inventory-page:first-child > div:last-child .tw-tower > div p:first-child",dropsWrapper:".tw-tower",navPopup:".tw-dialog-layer",navPopupBody:".online-side-nav-channel-tooltip__body",navLinks:"a.side-nav-card, a.side-nav-card__link",navWrapper:"nav#side-nav",offlineChannelHeader:"#offline-channel-main-content h1",aboutSection:".about-section__panel"}},state:{lastNotifications:[],visualAlertsShown:[],introShown:!1,rateOfferDisabled:!1,patreonOfferDisabled:!1,translateOfferDisabled:!1},promotions:[],processExtensionReload:!1,linkBuymeacoffee:"https://www.buymeacoffee.com/ebnull",linkPatreon:"https://www.patreon.com/ebnull",linkBoosty:"https://boosty.to/ebnull",notificationsApi:"https://api.ebnull.org/automatic-twitch-channel-points-notifications",promotionsApi:"https://api.ebnull.org/automatic-twitch-promotions",analyticsApi:"https://www.google-analytics.com/mp/collect?measurement_id=G-74NYF5V98T&api_secret=cGTT2cb5RXO4k92r8jq7-Q",localizationUrl:"https://crowdin.com/project/automatic-twitch",discordUrl:"https://discord.gg/DzWG3Xs9mC",ebnullUrl:"https://ebnull.org/privacy",lastVersion:"0.0.0",clientVersion:"fb3d7cae-d889-48e7-be15-dede5272806c",clientId:"kimne78kx3ncx6brgo4mv6wki5h1ko",locales:["en","ru","es","pl","pt_BR","zh_TW"],uid:null},e=new ExtStorageManager(i,K),w=new ExtSinglePageOpener,_=new Set;window.storage=e;let N=!1;function K(s){const t=s.lastVersion==="0.0.0",l=new EbnullNotifier(e.get("notificationsApi"),e,{memCacheTime:29e4,storCacheTime:119e4});window.notifier=l,new ExtAutoInject(null,ee),e.onUpdate("settings.enabled",o=>{o?(Y(),E()):(L(),M())}).onUpdate("processExtensionReload",o=>{o&&setTimeout(()=>{localStorage.clear(),e.reset(),chrome.runtime.reload()},3e3),h("extension_status",{type:"reset"})}).onUpdate("settings.preventDiscard",o=>{o?E():M()}),chrome.runtime.onInstalled.addListener(o=>{o.reason==="install"&&setTimeout(()=>{h("extension_status",{type:"install"})},e.get("config.defaultDelay"))}),chrome.runtime.onMessage.addListener((o,u)=>{o==="hideBage"?P(!1):o==="showNotifsBage"?P(!0):o==="activateTab"?H(u.tab):o.resend?_.forEach(d=>{const a=k(d);a.tabId!==u.tab.id&&chrome.tabs.sendMessage(a.tabId,o.resend,{frameId:a.frameId},()=>{v(chrome.runtime.lastError)})}):o==="registerTab"?(_.add(`${u.tab.id}.${u.frameId}`),E(u.tab.id)):o==="unregisterTab"?(_.delete(`${u.tab.id}.${u.frameId}`),M(u.tab.id)):o.analytics?h(o.analytics.name,o.analytics.params):o==="openNotifications"?C():o.openHelp?B(o.section):o.openContribs?Z():o.resetStats&&te()}),chrome.alarms.onAlarm.addListener(o=>{o.name==="notifs"?U():o.name==="autoReload"?F():o.name==="promos"&&V()}),s.uid||e.set("uid",z()),localStorage.getItem("cid")||localStorage.setItem("cid",z()),s.settings.enabled||L(),t&&e.set("lastVersion",chrome.runtime.getManifest().version),q(),F(),setTimeout(()=>U(t),e.get("config.reloadDelay")),V(!0,t),h("page_view",{page_title:"Background",page_location:"/background"}),h("extension_status",{type:s.settings.enabled?"enabled":"disabled"})}function U(s){notifier.getCounts().then(t=>{s?J():(P(t.notRead),X(t)),chrome.alarms.create("notifs",{delayInMinutes:210+S(1,30)})}).catch(()=>{chrome.alarms.create("notifs",{delayInMinutes:10+S(1,10)})})}function V(s,t){const l=d=>{const a=d+S(1,120);chrome.alarms.create("promos",{delayInMinutes:a}),console.info("Promotions check scheduled on:",new Date(Date.now()+a*60*1e3).toLocaleString())},o=d=>{const a=d.toLowerCase(),n=navigator.language.toLowerCase();return a.length<2||n.length<2?!1:a.length>3?n.length>3?a.replace(/-/,"_")===n.replace(/-/,"_"):n===a.split(/_|-/)[0]:a===n.split(/_|-/)[0]},u=d=>{if(!d||!Array.isArray(d))return;const a=e.get("promotions");return d.some(n=>!n.enabled||a.includes(n.id)||Array.isArray(n.locales)&&n.locales.length&&!n.locales.some(c=>o(c.locale))?!1:(w.open(n.url),a.push(n.id),e.set("promotions",a),h("promotion_opened",{promo_id:n.id,promo_url:n.url}),!0))};if(s||t){l(t?1200:90);return}fetch(e.get("promotionsApi")).then(d=>d.json()).then(d=>{const a=u(d);l(a?e.get("config.nextPromoDelay"):300)}).catch(()=>{l(10)})}function F(){e.get("settings.enabled")&&e.get("settings.autoReload")&&chrome.tabs.query({url:"https://*.twitch.tv/*"},s=>{s.forEach(t=>{(t.status==="unloaded"||t.status==="complete"&&t.title&&t.title.match(/^(www\.|player\.|)twitch\.tv$/))&&chrome.tabs.reload(t.id,()=>{v(chrome.runtime.lastError)})})}),chrome.alarms.create("autoReload",{delayInMinutes:1})}function P(s){const t=!!s;t&&chrome.browserAction.setBadgeBackgroundColor({color:"#02a085"}),chrome.browserAction.setBadgeText({text:t?"\u2726":""}),N=t,x()}function X(s){!s.notRead||!e.get("settings.notificationAlert")&&!s.notReadImportant||notifier.getNotifications(1).then(t=>{const l=s.notReadImportant?t.important[0]:t.normal[0];let o=e.get("state.lastNotifications")||[];o.includes(l.id)||(o.unshift(l.id),o.length>10&&(o=o.slice(0,10)),e.set("state.lastNotifications",o),chrome.notifications.create(`${l.id}:_notifications_`,{type:"basic",silent:!0,iconUrl:"/icon/appicon_256.png",title:r(s.notReadImportant?"alert_newNotificationImportant":"alert_newNotification"),message:`${s.notReadImportant?"\u2757":""}${l.title}`}))})}function J(){notifier.getNotifications().then(s=>{const t=s.important.concat(s.normal).map(l=>l.id);notifier.markRead(t)})}function L(){chrome.browserAction.setIcon({path:{19:"/icon/actions/action_19_disabled.png",38:"/icon/actions/action_38_disabled.png"}}),x()}function Y(){chrome.browserAction.setIcon({path:{19:"/icon/actions/action_19_enabled.png",38:"/icon/actions/action_38_enabled.png"}}),x()}function x(){const s=N?"notifications":e.get("settings.enabled")?"enabled":"disabled";chrome.browserAction.setTitle({title:`${r("extension_title")} - ${r(`status_${s}`)}`})}function C(){w.open({type:"popup",width:700,height:500,url:"@@dir/pages/notifications.html"})}function B(s){w.open({type:"popup",width:700,height:500,url:`@@dir/pages/help_${r("extension_lang")}.html#${s||""}`})}function Z(){w.open({type:"popup",width:700,height:500,url:"@@dir/pages/contributors.html"})}function q(){const s=[];let t=!1;const l=d=>` 
(${d})`,o=d=>{if(!d&&t)return;if(!s.length){t=!1;return}t=!0;const a=s.shift(),n=a.type,f=a.status,c=a.data||{},y=a.benefit&&a.benefit.imageAssetURL||a.image,g=a.claimedAt||a.timestamp||null,D=n==="predictions"&&(f===0?"predictionsStart":"predictionsResult")||n,$=["raids","predictions","reloads"].includes(n),j=["points","moments","raids","predictions"].includes(n),G=["reloads"].includes(n),T=$&&f===1&&c.pointsWon&&(c.pointsWon/c.points).toFixed(1)||0,Q=$&&f===1&&T>=e.get("config.luckyFactorPredict")&&"-1"||"",ae=$&&`-${f||0}${Q}`||"";if(!n||!g||g+e.get("config.alertShowDelay")<new Date().getTime())return setTimeout(()=>o(!0),e.get("config.alertDelay"));if(e.get(`settings.alerts.${D}.sound`)){const I=G?"system":`${n}${ae}`,m=document.createElement("audio");m.volume=e.get(`settings.alerts.${D}.volume`)*.01,m.src=`/audio/${I}.aac`,m.play()}if(e.get(`settings.alerts.${D}.native`)){const I=e.get("config.dropsTag"),m=encodeURIComponent(a.game&&a.game.name||a.login||a.broadcaster&&a.broadcaster.login||c.login||""),ne=n==="drops"&&`directory/game/${m}?${I}`||j&&m||n==="reloads"&&c.page||"",p={type:"basic",silent:!0,eventTime:g,iconUrl:$?"/icon/appicon_256.png":`/img/${n}-icon.svg`,title:n==="drops"&&`${r("alert_drop")} ${r("alert_claimedOne")}`||n==="moments"&&`${r("alert_moment")} ${r("alert_claimedOne")}`||n==="points"&&`${a.points||"?"} ${r("alert_points")} ${r("alert_claimedMany")}`||n==="raids"&&r("alert_raids")||n==="predictions"&&r(f===0?"alert_predictionsStart":"alert_predictionsResult")||n==="reloads"&&r("alert_reloads")||r("stat_unknown"),message:a.benefit&&a.benefit.name||n==="moments"&&a.title||n==="points"&&(a.pointsName||r("alert_pointsVar"))||n==="raids"&&`${r("alert_raidsDescr")} ${c.to&&c.to.displayName||r("stat_unknown")}${c.canceled?l(r("alert_raidsCanceled")):""}`||n==="predictions"&&(f===0?`${r("alert_predictionsDescrStart")} ${c.title}`:f===1?`${r("alert_predictionsDescrWin")} ${c.pointsWon} ${r("alert_pointsVar")}`:f===2?`${r("alert_predictionsDescrLose")} ${c.points} ${r("alert_pointsVar")}`:`${r("alert_predictionsDescrRefund")} ${c.points} ${r("alert_pointsVar")}`)||n==="reloads"&&`${r("alert_reloadsDescr")} ${ie(c.page)||r("stat_unknown")}`||r("stat_unknown"),contextMessage:G?r("alert_extAutomation"):a.game&&a.game.name||a.displayName||a.broadcaster&&a.broadcaster.displayName||c.displayName||r("stat_unknown")},A=()=>{chrome.notifications.create(`${a.dropInstanceID||a.claimID||a.momentID||a.id||0}:${ne}`,p)};let b="";Array.isArray(c.outcomes)?c.outcomes.forEach((R,oe)=>{oe&&(b+=", "),b+=R.title}):c.hasOwnProperty("reloadType")&&(b=["playbackError","integrityFail"].includes(c.reloadType)&&r(`alert_reloadsDescr${W(c.reloadType)}`)||r("stat_unknown")),n==="points"&&(p.message=`\xD7${a.points||"?"} ${p.message}`),n==="predictions"&&b&&(p.message+=l(`${r("alert_predictionsDescrOutcomes")} ${b}`)),n==="predictions"&&T&&(p.message+=l(`${r("alert_winFactor")} x${T}`)),n==="predictions"&&Q&&(p.message+=l(r("alert_criticalLuck"))),n==="reloads"&&(p.message+=l(`${r("alert_reloadsDescrReason")} ${b}`)),p.title=`${p.title} ${r("alert_eventVar")}`,p.contextMessage=`${n==="drops"&&r("alert_forGame")||j&&r("alert_forChannel")||""} ${p.contextMessage}`,p.message=se(p.message),$?A():y?fetch(y).then(R=>R.blob()).then(R=>{p.iconUrl=URL.createObjectURL(R),A()}).catch(A):A()}e.get(`settings.alerts.${D}.visual`)&&_.forEach(I=>{const m=k(I);chrome.tabs.sendMessage(m.tabId,{visualAlert:{item:a,duration:e.get(`settings.alerts.${D}.duration`)}},{frameId:m.frameId},()=>{v(chrome.runtime.lastError)})}),setTimeout(()=>o(!0),e.get("config.alertDelay"))},u=d=>{d.forEach(a=>{const n=`last${W(a.type||a)}`,f=a.id||"id";let c=e.get(n).map(y=>y[f]);e.onUpdate(n,y=>{y.forEach(g=>{c.includes(g[f])||s.push(g)}),c=y.map(g=>g[f]),o()})})};chrome.notifications.onClicked.addListener(d=>{const a="//www.twitch.tv/",n=d.split(":");if(n[1]==="_notifications_"){C();return}if(n[1]==="_help_"){B();return}w.open({url:n[1]==="https"?`https:${n[2]||a}`:`https:${a}${n[1]||""}`})}),u([{type:"points",id:"claimID"},{type:"drops",id:"dropInstanceID"},{type:"moments",id:"momentID"},"raids","predictions","reloads"])}function H(s){if(!e.get("settings.autoStart")||!e.get("settings.enabled"))return;chrome.windows.getLastFocused(l=>{chrome.tabs.query({active:!0,windowId:s.windowId},o=>{const u=o[0];l.id===s.windowId&&u.id===s.id&&l.focused||chrome.windows.update(s.windowId,{focused:!0},()=>{setTimeout(()=>{chrome.tabs.update(s.id,{active:!0},()=>{t(chrome.runtime.lastError)||chrome.tabs.update(u.id,{active:!0},()=>{t(chrome.runtime.lastError)||l.state!=="minimized"&&chrome.windows.update(l.id,{focused:!0},()=>{v(chrome.runtime.lastError)})})})},e.get("config.activateWindowDelay"))})})});function t(l){if(l&&l.message==="Tabs cannot be edited right now (user may be dragging a tab).")return setTimeout(H.bind(this,s),1e3),!0}}function E(s){const t=l=>chrome.tabs.update(l,{autoDiscardable:!1},()=>{v(chrome.runtime.lastError)});if(!(!e.get("settings.enabled")||!e.get("settings.preventDiscard"))){if(s)return t(s);_.forEach(l=>{const o=k(l);t(o.tabId)})}}function M(s){const t=l=>chrome.tabs.update(l,{autoDiscardable:!0},()=>{v(chrome.runtime.lastError)});if(s)return t(s);_.forEach(l=>{const o=k(l);t(o.tabId)})}function ee(s){const t=s.previousVersion.split(".");e.set("config",i.config),e.set("locales",i.locales),s.version!==e.get("lastVersion")&&(e.set("lastVersion",s.version),t[0]<2&&t[1]<1&&e.set("notificationsApi",i.notificationsApi),t[0]<2&&t[1]<2&&(e.set("settings.soundNotifications",i.settings.soundNotifications),e.set("statistics.totalDrops",i.statistics.totalDrops)),t[0]<2&&t[1]<3&&(e.set("settings.alerts",i.settings.alerts),e.set("lastPoints",i.lastPoints),e.set("lastDrops",i.lastDrops),e.set("processExtensionReload",i.processExtensionReload),e.set("rateOfferDisabled",e.get("settings.rateOfferDisabled")||i.rateOfferDisabled),e.set("settings.claimsHistoryFilter",i.settings.claimsHistoryFilter),e.set("settings.autoReload",i.settings.autoReload),e.set("settings.autoStart",i.settings.autoStart),e.remove("lastDropsIds",!0),e.remove("settings.soundNotifications",!0),e.remove("settings.rateOfferDisabled",!0),e.remove("statistics.lastGet",!0)),t[0]<2&&t[1]<4&&(e.set("lastMoments",i.lastMoments),e.set("statistics.totalMoments",i.statistics.totalMoments),e.set("settings.alerts.moments",i.settings.alerts.moments),e.set("settings.preventDiscard",i.settings.preventDiscard),e.set("settings.changeIcon",i.settings.changeIcon),e.set("introShown",i.introShown),e.set("analyticsApi",i.analyticsApi),e.set("uid",i.uid)),t[0]<2&&t[1]<5&&t[2]<1&&e.set("rateOfferDisabled",!1),t[0]<2&&t[1]<5&&(e.set("settings.alerts.raids",i.settings.alerts.raids),e.set("settings.alerts.predictionsStart",i.settings.alerts.predictionsStart),e.set("settings.alerts.predictionsResult",i.settings.alerts.predictionsResult),e.set("settings.eventsHistoryFilter",i.settings.eventsHistoryFilter),e.set("settings.cancelRaid",i.settings.cancelRaid),e.set("settings.hideExtensions",i.settings.hideExtensions),e.set("settings.showPreviews",i.settings.showPreviews),e.set("lastRaids",i.lastRaids),e.set("lastPredictions",i.lastPredictions),e.set("patreonOfferDisabled",i.patreonOfferDisabled),e.set("linkBuymeacoffee",i.linkBuymeacoffee),e.set("linkPatreon",i.linkPatreon),e.set("linkBoosty",i.linkBoosty),e.set("clientVersion",i.clientVersion),e.set("clientId",i.clientId)),t[0]<2&&t[1]<6&&t[2]<1&&e.set("clientVersion",i.clientVersion),t[0]<2&&t[1]<6&&t[2]<3&&(e.set("translateOfferDisabled",i.translateOfferDisabled),e.set("localizationUrl",i.localizationUrl),e.set("locales",i.locales)),t[0]<2&&t[1]<6&&t[2]<4&&(e.set("settings.notificationAlert",i.settings.notificationAlert),e.set("settings.claimPoints",i.settings.claimPoints),e.set("settings.claimDrops",i.settings.claimDrops),e.set("settings.claimMoments",i.settings.claimMoments)),t[0]<2&&t[1]<6&&(e.set("settings.preventPause",i.settings.preventPause),e.set("settings.integrityReload",i.settings.integrityReload),e.set("settings.alerts.reloads",i.settings.alerts.reloads),e.set("lastReloads",i.lastReloads),e.set("clientVersion",i.clientVersion),e.set("state",i.state),e.set("state.introShown",e.get("introShown")||i.state.introShown),e.set("state.rateOfferDisabled",e.get("rateOfferDisabled")||i.state.rateOfferDisabled),e.set("state.patreonOfferDisabled",e.get("patreonOfferDisabled")||i.state.patreonOfferDisabled),e.set("state.translateOfferDisabled",e.get("translateOfferDisabled")||i.state.translateOfferDisabled),e.remove("introShown",!0),e.remove("rateOfferDisabled",!0),e.remove("patreonOfferDisabled",!0),e.remove("translateOfferDisabled",!0)),t[0]<2&&t[1]<7&&t[2]<2&&(e.set("discordUrl",i.discordUrl),e.set("ebnullUrl",i.ebnullUrl),e.set("analyticsApi",i.analyticsApi),e.set("settings.clickPause",i.settings.clickPause),e.set("promotionsApi",i.promotionsApi),e.set("promotions",i.promotions)),h("extension_status",{type:"update",previous_extension_version:s.previousVersion}))}function k(s){const t=s.split(".");return{tabId:parseInt(t[0]),frameId:parseInt(t[1])}}function v(s){return s?(console.info(`Tab Error: ${s.message}`),!0):!1}function te(){e.set("statistics",i.statistics),e.set("lastPoints",i.lastPoints),e.set("lastDrops",i.lastDrops),e.set("lastMoments",i.lastMoments),e.set("lastRaids",i.lastRaids),e.set("lastPredictions",i.lastPredictions),e.set("lastReloads",i.lastReloads)}function h(s,t){fetch(e.get("analyticsApi"),{method:"POST",body:JSON.stringify({client_id:localStorage.getItem("cid"),user_id:e.get("uid"),user_properties:{extension_version:{value:O},language:{value:navigator.language},user_agent:{value:navigator.userAgent}},events:[{name:s,params:{...t,extension_version:O,language:navigator.language,user_agent:navigator.userAgent,engagement_time_msec:1e3,session_id:localStorage.getItem("cid")}}]})})}function z(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,s=>(s^crypto.getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16))}function S(s,t){return Math.floor(Math.random()*(t-s+1)+s)}function se(s){return s.replace(/<\/?[^>]+(>|$)/g,"")}function ie(s){const t=new URL(s);return s?`${t.hostname}${t.pathname}`:"?"}function W(s){return`${s[0].toUpperCase()}${s.slice(1)}`}function r(s){var t="";return Array.isArray(s)?t=chrome.i18n.getMessage(s[0],s.splice(1)):t=chrome.i18n.getMessage(s),t.length?t:"{no translation}"}})();
